rule "when movie mode is turned on"
when
  Item Basement_Movie_Mode_Switch received command ON
then
  Basement_Stairs_Switch.sendCommand(OFF)
  Basement_Room_Lights_Switch.sendCommand(OFF)
  Basement_Room_Theater_Lights.sendCommand(9)
  Basement_Room_Bar_Lights.sendCommand(10)

  createTimer(now.plusSeconds(10), [|
    Basement_Movie_Mode_Switch.postUpdate(OFF)
  ])
end

rule "when normal mode is turned on"
when
  Item Basement_Normal_Mode_Switch received command ON
then
  Basement_Stairs_Switch.sendCommand(ON)
  Basement_Room_Theater_Lights.sendCommand(100)
  Basement_Room_Bar_Lights.sendCommand(100)

  createTimer(now.plusSeconds(10), [|
    Basement_Normal_Mode_Switch.postUpdate(OFF)
  ])
end

rule "when someone enters/leaves downstairs"
when
  Item C_Total_Basement_Occupancy changed
then
  val previous_count = C_Total_Basement_Occupancy.previousState(true, "jdbc").state
  val occupancy_count = C_Total_Basement_Occupancy.state
  if (occupancy_count > 0) {
    if (Basement_Stairs_Switch.state != ON && previous_count < occupancy_count) {
      Basement_Stairs_Switch.sendCommand(ON)
    }
  } else {
    C_All_Lights.members.forEach [ i |
      if (i.state != OFF) {
        i.sendCommand(OFF)
      }
    ]
  }
end

rule "When the count of the occupancy sensor changes"
when
  Item Hiome_Basement_Occupancy_Count received update
  or
  Item Hiome_Exercise_Room_Occupancy_Count received update
then
  // Have a small delay while the hiome updates finish
  createTimer(now.plusMillis(80), [|
    val new_total_occupancy = Hiome_Basement_Occupancy_Count.state as Number + Hiome_Exercise_Room_Occupancy_Count.state as Number
    C_Total_Basement_Occupancy.postUpdate(new_total_occupancy)
  ])
end

rule "when the exersize room dimmer has a scene change"
when
  Item Exercise_Room_Dimmer_Scene_Number received update
then
  var scene = Exercise_Room_Dimmer_Scene_Number.state as DecimalType
  if (scene == 1.3) {
    if (Basement_Stairs_Switch.state != ON) {
      Basement_Stairs_Switch.sendCommand(ON)
    }
  } else if (scene == 2.3) {
    if (Basement_Stairs_Switch.state != OFF) {
      Basement_Stairs_Switch.sendCommand(OFF)
    }
  }
end

rule "when someone enters/leaves the exersize room"
when
  Item Hiome_Exercise_Room_Occupancy_Count changed
then
  if (occupancy_count > 0) {
    if (Exercise_Room_Light.state != ON) {
      Exercise_Room_Light.sendCommand(ON)
    }
  } else {
    if (Exercise_Room_Light.state != OFF) {
      Exercise_Room_Light.sendCommand(OFF)
    }
  }
end
